!function(i,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(i.THREEi=i.THREEi||{})}(this,function(i){"use strict";var t;function s(){const i=t.d*t.d,s=(i,t,s)=>i*i+t*t+s*s,n=(i,t,s)=>Math.sqrt(i*i+t*t+s*s),o=i=>0!==i?i-1:oi.length-1,e=i=>i!==oi.length-1?i+1:0,a=(i,t,s,n,o,e,a,h,l)=>i*o*l+t*e*a+s*n*h-s*o*a-i*e*h-t*n*l;let h,l,d,c,r,p,u,f,g,M,x,v,b,A,I,m,P,y,T,B,E,w,H,k,N,R,q,W,S,U,F,_,G,j,z,C,O,X,D,J,K,L;const Q=t.detail*t.detail*6;t.indices=new Uint32Array(t.detail*t.detail*8*3),t.positions=new Float32Array(3*Q),t.setIndex(new THREE.BufferAttribute(t.indices,1)),t.addAttribute("position",new THREE.BufferAttribute(t.positions,3));let V,Y,Z,$,ii,ti,si=0,ni=0,oi=[],ei=[],ai=[],hi=[],li=[],di=[],ci=[],ri=!1,pi=!1;if(ii=0,ti=0,0===t.holes.length)hi[ii]=[],di[ii]=[],Bi(0,0),Bi(Math.PI/2/t.div4,-Math.PI/6),Bi(Math.PI/2/t.div4,Math.PI/6),t.indices[0]=0,t.indices[1]=1,t.indices[2]=2,ni+=3,hi[ii].push({idx:0,ang:0},{idx:1,ang:0},{idx:2,ang:0}),ii++,ti++;else{t.circles=[];for(let i=0;i<t.holes.length;i++)3===t.holes[i].length?fi(i):ui(i)}for(ii=0,oi=hi[ii];ti>0;)if(ri||pi)ri?(Mi(h,v,A,b),c=0,yi(Y),yi(Y+1),oi[Y].ang<oi[Y+1].ang?(Ii(Y),c+=l-1,yi(Y+1+c),Ii(Y+1+c),c+=l-1):(Ii(Y+1),c+=l-1,yi(Y),Ii(Y),c+=l-1),yi(Z+c),yi(Z+1+c),oi[Z+c].ang<oi[Z+1+c].ang?(Ii(Z+c),c+=l-1,yi(Z+1+c),Ii(Z+1+c)):(Ii(Z+1+c),yi(Z+c),Ii(Z+c)),ri=!1):pi&&(vi(M,x),bi(),pi=!1);else{ci=[];for(let i=0;i<oi.length;i++)0===oi[i].ang&&yi(i);h=Ai(),Ii(h),oi.length>9&&0===ci.length&&(gi(h),xi(h)),3===oi.length&&(t.indices[ni]=oi[2].idx,t.indices[ni+1]=oi[1].idx,t.indices[ni+2]=oi[0].idx,ni+=3,oi=[],hi[ii]=[],ti-=1,mi())}function ui(i){let s,o,e,a,h,l,d,c,r,u,f,g;a=h=l=1/0,d=c=r=-1/0,hi[ii]=[],di[ii]=[],s=t.holes[i][0],o=t.holes[i][1],E=t.radius*Math.sin(s)*Math.cos(o),w=t.radius*Math.cos(s),H=-t.radius*Math.sin(s)*Math.sin(o);for(let M=1;M<t.holes[i].length/2+1;M++){if(t.positions[si]=E,t.positions[si+1]=w,t.positions[si+2]=H,hi[ii].push({idx:si/3,ang:0}),a=E<a?E:a,h=w<h?w:h,l=H<l?H:l,d=E>d?E:d,c=w>c?w:c,r=H>r?H:r,si+=3,s=t.holes[i][M<t.holes[i].length/2?2*M:0],o=t.holes[i][M<t.holes[i].length/2?2*M+1:1],k=t.radius*Math.sin(s)*Math.cos(o),N=t.radius*Math.cos(s),R=-t.radius*Math.sin(s)*Math.sin(o),u=k-E,f=N-w,g=R-H,p=n(u,f,g),p>t.d){e=Math.ceil(p/t.d);for(let i=1;i<e;i++)I=E+i*u/e,m=w+i*f/e,P=H+i*g/e,p=n(I,m,P),t.positions[si]=t.radius*I/p,t.positions[si+1]=t.radius*m/p,t.positions[si+2]=t.radius*P/p,hi[ii].push({idx:si/3,ang:0}),a=I<a?I:a,h=m<h?m:h,l=P<l?P:l,d=I>d?I:d,c=m>c?m:c,r=P>r?P:r,si+=3}E=k,w=N,H=R}di[ii].push(a,d,h,c,l,r),ii++,ti++}function fi(i){let s,n,o,e,a;const h=t.holes[i][0],l=t.holes[i][1],d=t.holes[i][2],c=4*d;let r,p,u,f,g,M;r=p=u=1/0,f=g=M=-1/0;const x=t.d/(2*Math.sin(Math.PI/c)),v=Math.sqrt(t.radius*t.radius-x*x);y=t.radius*Math.sin(h)*Math.cos(l),T=t.radius*Math.cos(h),B=-t.radius*-Math.sin(h)*Math.sin(l),J=v/t.radius*y,K=v/t.radius*T,L=v/t.radius*B,t.circles.push([J,K,L,x,d]),hi[ii]=[],di[ii]=[],n=v;for(let b=0,A=0;b<c;b++,A+=2*Math.PI/c)s=x*Math.cos(A),o=x*Math.sin(A),e=s*Math.cos(h)-n*Math.sin(h),a=s*Math.sin(h)+n*Math.cos(h),I=-e*Math.cos(l)+o*Math.sin(l),P=e*Math.sin(l)+o*Math.cos(l),m=a,t.positions[si]=I,t.positions[si+1]=m,t.positions[si+2]=P,hi[ii].push({idx:si/3,ang:0}),r=I<r?I:r,p=m<p?m:p,u=P<u?P:u,f=I>f?I:f,g=m>g?m:g,M=P>M?P:M,si+=3;di[ii].push(r,f,p,g,u,M),ii++,ti++}function gi(n){let o,e,a,h,l,d=1/0;ri=!1;for(let c=0;c<ai.length;c++){Ei(n+c);for(let n=0;n<hi.length;n++)if(n!==ii&&(e=y>di[n][0]-t.d&&y<di[n][3]+t.d,a=T>di[n][1]-t.d&&T<di[n][4]+t.d,h=B>di[n][2]-t.d&&B<di[n][5]+t.d,e||a||h))for(let e=0;e<hi[n].length;e++)o=3*hi[n][e].idx,k=t.positions[o],N=t.positions[o+1],R=t.positions[o+2],l=s(k-y,N-T,R-B),l<i&&l<d&&(d=l,v=c,b=e,A=n,ri=!0)}}function Mi(i,t,s,n){let o=[];o[0]=oi.slice(0,i+t+1),o[1]=hi[s].slice(n,hi[s].length),o[2]=hi[s].slice(0,n+1),o[3]=oi.slice(i+t,oi.length),Y=i+t,Z=i+t+1+hi[s].length,oi=[];for(let e=0;e<4;e++)for(let i=0;i<o[e].length;i++)oi.push(o[e][i]);hi[s]=[],ti-=1}function xi(n){let o,e,a,h=1/0;pi=!1;for(let d=0;d<oi.length;d++)for(let c=0;c<l;c++)o=n+c,Math.abs(d-o)>3&&Math.abs(d-o)<oi.length-3&&(e=3*oi[o].idx,E=t.positions[e],w=t.positions[e+1],H=t.positions[e+2],Ei(d),a=s(E-y,w-T,H-B),a<i&&a<h&&(h=a,M=d,x=o,pi=!0))}function vi(i,s){let n;oi[i].ang=0,oi[s].ang=0,i>s&&(n=s,s=i,i=n),$=i,ei=[];let o=oi[i],e=oi[s];ei=oi.splice(i+1,s-i-1),ei.unshift(o),ei.push(e),hi.push(ei),function(){let i,s,n,o,e,a,h;li=[],s=n=o=1/0,e=a=h=-1/0;for(let l=0;l<ei.length;l++)i=3*ei[l].idx,I=t.positions[i],m=t.positions[i+1],P=t.positions[i+2],s=I<s?I:s,n=m<n?m:n,o=P<o?P:o,e=I>e?I:e,a=m>a?m:a,h=P>h?P:h;li.push(s,n,o,e,a,h),di.push(li)}(),ti+=1}function bi(){c=0;let i=$,t=$+1;yi(i),yi(t),oi[t].ang<oi[i].ang?(Ii(t),c+=l-1,yi(i),Ii(i)):(Ii(i),c+=l-1,yi(t+c),Ii(t+c))}function Ai(){let i,t=1/0;for(let s=0;s<oi.length;s++)oi[s].ang<t&&(t=oi[s].ang,i=s);return i}function Ii(s){if(ai=[],d=Math.floor(3*oi[s].ang/Math.PI)+1,r=oi[s].ang/d,Ti(s),wi(s),u=n(E-y,w-T,H-B),f=n(k-y,N-T,R-B),g=n(k-E,N-w,R-H),r<.8&&d>1&&(d--,r=oi[s].ang/d),r>.8&&1===d&&g>1.25*t.d&&(d=2,r=oi[s].ang/d),(u*u<.2*i||f*f<.2*i)&&(d=1),l=d-1,0===l)t.indices[ni]=oi[s].idx,t.indices[ni+1]=oi[o(s)].idx,t.indices[ni+2]=oi[e(s)].idx,ni+=3,oi[o(s)].ang=0,oi[e(s)].ang=0,oi.splice(s,1);else{J=y,K=T,L=B;for(let i=0,s=r;i<l;i++,s+=r)y=J+Math.cos(s)*t.d*U+Math.sin(s)*t.d*G,T=K+Math.cos(s)*t.d*F+Math.sin(s)*t.d*j,B=L+Math.cos(s)*t.d*_+Math.sin(s)*t.d*z,p=n(y,T,B),t.positions[si]=t.radius*y/p,t.positions[si+1]=t.radius*T/p,t.positions[si+2]=t.radius*B/p,ai.push({idx:si/3,ang:0}),si+=3;t.indices[ni]=oi[s].idx,t.indices[ni+1]=oi[o(s)].idx,t.indices[ni+2]=ai[0].idx,ni+=3,oi[o(s)].ang=0;for(let i=0;i<l-1;i++)t.indices[ni]=oi[s].idx,t.indices[ni+1]=ai[i].idx,t.indices[ni+2]=ai[i+1].idx,ni+=3;t.indices[ni]=oi[s].idx,t.indices[ni+1]=ai[l-1].idx,t.indices[ni+2]=oi[e(s)].idx,oi[e(s)].ang=0,ni+=3,function(i,t){let s=oi.splice(i,oi.length-i);for(let n=0;n<t.length;n++)oi.push(t[n]);for(let n=1;n<s.length;n++)oi.push(s[n])}(s,ai)}}function mi(){if(ti>0){for(let i=0;i<hi.length;i++)if(hi[i].length>0){ii=i;break}oi=hi[ii],ci=[];for(let i=0;i<oi.length;i++)yi(i)}}function Pi(i,t){let s=Math.atan2(t,i);return s<0&&(s+=2*Math.PI),s}function yi(i){let t,s;Ti(i),wi(i),function(){let i=a(U,F,_,G,j,z,q,W,S);C=a(E-y,w-T,H-B,G,j,z,q,W,S)/i,O=a(U,F,_,E-y,w-T,H-B,q,W,S)/i,X=a(k-y,N-T,R-B,G,j,z,q,W,S)/i,D=a(U,F,_,k-y,N-T,R-B,q,W,S)/i}(),t=Pi(C,O),s=Pi(X,D),s<t&&(s+=2*Math.PI),oi[i].ang=s-t,oi[i].ang<1.5&&ci.push(i)}function Ti(i){!function(i){V=3*oi[o(i)].idx,E=t.positions[V],w=t.positions[V+1],H=t.positions[V+2]}(i),Ei(i),p=n(y,T,B),q=y/p,W=T/p,S=B/p;const s=Math.abs(E*y+w*T+H*B)/t.radius;J=s/t.radius*y,K=s/t.radius*T,L=s/t.radius*B,U=E-J,F=w-K,_=H-L,p=n(U,F,_),U/=p,F/=p,_/=p,G=W*_-S*F,j=S*U-q*_,z=q*F-W*U}function Bi(i,s){t.positions[si]=t.radius*Math.sin(i)*Math.cos(s),t.positions[si+1]=t.radius*Math.cos(i),t.positions[si+2]=-t.radius*Math.sin(i)*Math.sin(s),si+=3}function Ei(i){V=3*oi[i].idx,y=t.positions[V],T=t.positions[V+1],B=t.positions[V+2]}function wi(i){V=3*oi[e(i)].idx,k=t.positions[V],N=t.positions[V+1],R=t.positions[V+2]}}function n(){const i=(i,t,s)=>i*i+t*t+s*s,s=(i,t,s)=>Math.sqrt(i*i+t*t+s*s),n=i=>0!==i?i-1:di.length-1,o=i=>i!==di.length-1?i+1:0;let e,a,h,l,d,c,r,p,u,f,g,M,x,v,b,A,I,m,P,y,T,B,E,w,H,k,N,R,q,W,S,U,F,_,G,j,z,C,O,X,D,J,K,L,Q,V,Y,Z;const $=t.detail*t.detail*10;t.indices=new Uint32Array(t.detail*t.detail*15*3),t.positions=new Float32Array(3*$),t.setIndex(new THREE.BufferAttribute(t.indices,1)),t.addAttribute("position",new THREE.BufferAttribute(t.positions,3)),e=Math.PI/t.detail;const ii=e*e;let ti,si,ni,oi,ei,ai,hi=0,li=0,di=[],ci=[],ri=[],pi=[],ui=[],fi=[],gi=[],Mi=!1,xi=!1;if(ei=0,ai=0,0===t.holes.length)pi[ei]=[],fi[ei]=[],vi(0,0),vi(e,-Math.PI/6),vi(e,Math.PI/6),t.indices[0]=0,t.indices[1]=1,t.indices[2]=2,li+=3,pi[ei].push({idx:0,ang:0},{idx:1,ang:0},{idx:2,ang:0}),ei++,ai++;else{t.circles=[];for(let i=0;i<t.holes.length;i++)3===t.holes[i].length?Ai(i):bi(i)}for(ei=0,di=pi[ei];ai>0;)if(Mi||xi)Mi?(mi(a,A,m,I),d=0,Hi(si),Hi(si+1),di[si].ang<di[si+1].ang?(Ei(si),d+=h-1,Hi(si+1+d),Ei(si+1+d),d+=h-1):(Ei(si+1),d+=h-1,Hi(si),Ei(si),d+=h-1),Hi(ni+d),Hi(ni+1+d),di[ni+d].ang<di[ni+1+d].ang?(Ei(ni+d),d+=h-1,Hi(ni+1+d),Ei(ni+1+d)):(Ei(ni+1+d),Hi(ni+d),Ei(ni+d)),Mi=!1):xi&&(yi(v,b),Ti(),xi=!1);else{gi=[];for(let i=0;i<di.length;i++)0===di[i].ang&&Hi(i);a=Bi(),Ei(a),di.length>9&&0===gi.length&&(Ii(a),Pi(a)),3===di.length&&(t.indices[li]=di[2].idx,t.indices[li+1]=di[1].idx,t.indices[li+2]=di[0].idx,li+=3,di=[],pi[ei]=[],ai-=1,wi())}function vi(i,s){t.positions[hi]=Math.sin(i)*Math.cos(s),t.positions[hi+1]=Math.cos(i),t.positions[hi+2]=-Math.sin(i)*Math.sin(s),hi+=3}function bi(i){let n,o,a,h,l,d,c,p,u;h=l=d=1/0,c=p=u=-1/0,pi[ei]=[],fi[ei]=[],n=t.holes[i][0],o=t.holes[i][1],S=Math.sin(n)*Math.cos(o),U=Math.cos(n),F=-Math.sin(n)*Math.sin(o);for(let f=1;f<t.holes[i].length/2+1;f++){if(t.positions[hi]=S,t.positions[hi+1]=U,t.positions[hi+2]=F,pi[ei].push({idx:hi/3,ang:0}),h=S<h?S:h,l=U<l?U:l,d=F<d?F:d,c=S>c?S:c,p=U>p?U:p,u=F>u?F:u,hi+=3,n=t.holes[i][f<t.holes[i].length/2?2*f:0],o=t.holes[i][f<t.holes[i].length/2?2*f+1:1],_=Math.sin(n)*Math.cos(o),G=Math.cos(n),j=-Math.sin(n)*Math.sin(o),V=_-S,Y=G-U,Z=j-F,r=s(V,Y,Z),r>e){a=Math.ceil(r/e);for(let i=1;i<a;i++)B=S+i*V/a,E=U+i*Y/a,w=F+i*Z/a,r=s(B,E,w),t.positions[hi]=B/r,t.positions[hi+1]=E/r,t.positions[hi+2]=w/r,pi[ei].push({idx:hi/3,ang:0}),h=B<h?B:h,l=E<l?E:l,d=w<d?w:d,c=B>c?B:c,p=E>p?E:p,u=w>u?w:u,hi+=3}S=_,U=G,F=j}fi[ei].push(h,c,l,p,d,u),ei++,ai++}function Ai(i){let n,o,e,a,h,l,d=t.holes[i][0],c=t.holes[i][1],p=t.holes[i][2];n=o=e=1/0,a=h=l=-1/0,H=Math.sin(d)*Math.cos(c),k=Math.cos(d),N=-Math.sin(d)*Math.sin(c);let u=p/detail/2;P=Math.sqrt(1-u*u),0!==H||0!==k?(z=-k,C=H,O=0):(z=0,C=1,O=0),X=k*O-N*C,D=N*z-H*O,J=H*C-k*z,r=s(z,C,O),z/=r,C/=r,O/=r,r=s(X,D,J),X/=r,D/=r,J/=r,R=P*H,q=P*k,W=P*N,t.circles.push([R,q,W,u,p]),pi[ei]=[],fi[ei]=[];for(let s=0,r=0;s<p;s++,r+=2*Math.PI/p)B=R+Math.cos(r)*u*z+Math.sin(r)*u*X,E=q+Math.cos(r)*u*C+Math.sin(r)*u*D,w=W+Math.cos(r)*u*O+Math.sin(r)*u*J,t.positions[hi]=B,t.positions[hi+1]=E,t.positions[hi+2]=w,pi[ei].push({idx:hi/3,ang:0}),n=B<n?B:n,o=E<o?E:o,e=w<e?w:e,a=B>a?B:a,h=E>h?E:h,l=w>l?w:l,hi+=3;fi[ei].push(n,a,o,h,e,l),ei++,ai++}function Ii(s){let n,o,a,h,l,d=1/0;Mi=!1;for(let c=0;c<ri.length;c++){Ni(s+c);for(let s=0;s<pi.length;s++)if(s!==ei&&(o=H>fi[s][0]-e&&H<fi[s][3]+e,a=k>fi[s][1]-e&&k<fi[s][4]+e,h=N>fi[s][2]-e&&N<fi[s][5]+e,o||a||h))for(let o=0;o<pi[s].length;o++)n=3*pi[s][o].idx,_=t.positions[n],G=t.positions[n+1],j=t.positions[n+2],l=i(_-H,G-k,j-N),l<ii&&l<d&&(d=l,A=c,m=s,I=o,Mi=!0)}}function mi(i,t,s,n){let o=[];o[0]=di.slice(0,i+t+1),o[1]=pi[s].slice(n,pi[s].length),o[2]=pi[s].slice(0,n+1),o[3]=di.slice(i+t,di.length),si=i+t,ni=i+t+1+pi[s].length,di=[];for(let e=0;e<4;e++)for(let i=0;i<o[e].length;i++)di.push(o[e][i]);pi[s]=[],ai-=1}function Pi(s){let n,o,e,a=1/0;xi=!1;for(let l=0;l<di.length;l++)for(let d=0;d<h;d++)n=s+d,Math.abs(l-n)>3&&Math.abs(l-n)<di.length-3&&(o=3*di[n].idx,S=t.positions[o],U=t.positions[o+1],F=t.positions[o+2],Ni(l),e=i(S-H,U-k,F-N),e<ii&&e<a&&(a=e,v=l,b=n,xi=!0))}function yi(i,s){let n;di[i].ang=0,di[s].ang=0,i>s&&(n=s,s=i,i=n),oi=i,ci=[];let o=di[i],e=di[s];ci=di.splice(i+1,s-i-1),ci.unshift(o),ci.push(e),pi.push(ci),function(){let i,s,n,o,e,a,h;ui=[],s=n=o=1/0,e=a=h=-1/0;for(let l=0;l<ci.length;l++)i=3*ci[l].idx,B=t.positions[i],E=t.positions[i+1],w=t.positions[i+2],s=B<s?B:s,n=E<n?E:n,o=w<o?w:o,e=B>e?B:e,a=E>a?E:a,h=w>h?w:h;ui.push(s,n,o,e,a,h),fi.push(ui)}(),ai+=1}function Ti(){d=0;let i=oi,t=oi+1;Hi(i),Hi(t),di[t].ang<di[i].ang?(Ei(t),d+=h-1,Hi(i),Ei(i)):(Ei(i),d+=h-1,Hi(t+d),Ei(t+d))}function Bi(){let i,t=1/0;for(let s=0;s<di.length;s++)di[s].ang<t&&(t=di[s].ang,i=s);return i}function Ei(i){var a;if(ri=[],l=Math.floor(3*di[i].ang/Math.PI)+1,c=di[i].ang/l,ki(a=i),Ni(a),P=Math.abs(S*H+U*k+F*N),R=P*H,q=P*k,W=P*N,z=S-R,C=U-q,O=F-W,r=s(z,C,O),z/=r,C/=r,O/=r,X=k*O-N*C,D=N*z-H*O,J=H*C-k*z,Ri(i),p=s(S-H,U-k,F-N),u=s(_-H,G-k,j-N),f=s(_-S,G-U,j-F),c<.8&&l>1&&(l--,c=di[i].ang/l),c>.8&&1===l&&f>1.25*e&&(l=2,c=di[i].ang/l),(p*p<.2*e*e||u*u<.2*e*e)&&(l=1),h=l-1,0===h)t.indices[li]=di[i].idx,t.indices[li+1]=di[n(i)].idx,t.indices[li+2]=di[o(i)].idx,li+=3,di[n(i)].ang=0,di[o(i)].ang=0;else{for(let i=0,n=c;i<h;i++,n+=c)H=R+Math.cos(n)*e*z+Math.sin(n)*e*X,k=q+Math.cos(n)*e*C+Math.sin(n)*e*D,N=W+Math.cos(n)*e*O+Math.sin(n)*e*J,r=s(H,k,N),t.positions[hi]=H/r,t.positions[hi+1]=k/r,t.positions[hi+2]=N/r,ri.push({idx:hi/3,ang:0}),hi+=3;t.indices[li]=di[i].idx,t.indices[li+1]=di[n(i)].idx,t.indices[li+2]=ri[0].idx,li+=3,di[n(i)].ang=0;for(let s=0;s<h-1;s++)t.indices[li]=di[i].idx,t.indices[li+1]=ri[s].idx,t.indices[li+2]=ri[s+1].idx,li+=3;t.indices[li]=di[i].idx,t.indices[li+1]=ri[h-1].idx,t.indices[li+2]=di[o(i)].idx,di[o(i)].ang=0,li+=3}!function(i,t){let s=di.splice(i,di.length-i);for(let n=0;n<t.length;n++)di.push(t[n]);for(let n=1;n<s.length;n++)di.push(s[n])}(i,ri)}function wi(){if(ai>0){for(let i=0;i<pi.length;i++)if(pi[i].length>0){ei=i;break}di=pi[ei],gi=[];for(let i=0;i<di.length;i++)Hi(i)}}function Hi(i){ki(i),Ni(i),Ri(i),P=Math.abs(S*H+U*k+F*N),R=P*H,q=P*k,W=P*N,K=R-S,L=q-U,Q=W-F,r=s(K,L,Q),K/=r,L/=r,Q/=r,V=_-R,Y=G-q,Z=j-W,r=s(V,Y,Z),V/=r,Y/=r,Z/=r,di[i].ang=Math.acos(Math.abs(K*V+L*Y+Q*Z)),B=L*Z-Q*Y,E=Q*V-K*Z,w=K*Y-L*V,r=s(B,E,w),B=H+B/r,E=k+E/r,w=N+w/r,T=s(B,E,w)<1,p=s(S-H,U-k,F-N),u=s(_-H,G-k,j-N),f=s(_-S,G-U,j-F),g=p*p,M=u*u,x=f*f,y=x<g+M,T&&!y&&(di[i].ang=Math.PI-di[i].ang),!T&&y&&(di[i].ang=2*Math.PI-di[i].ang),T||y||(di[i].ang=Math.PI+di[i].ang),di[i].ang<1.5&&gi.push(i)}function ki(i){ti=3*di[n(i)].idx,S=t.positions[ti],U=t.positions[ti+1],F=t.positions[ti+2]}function Ni(i){ti=3*di[i].idx,H=t.positions[ti],k=t.positions[ti+1],N=t.positions[ti+2]}function Ri(i){ti=3*di[o(i)].idx,_=t.positions[ti],G=t.positions[ti+1],j=t.positions[ti+2]}}function o(){const i=t.d*t.d,s=(i,t,s)=>i*i+t*t+s*s,n=(i,t,s)=>Math.sqrt(i*i+t*t+s*s),o=(i,t)=>Math.sqrt(i*i+t*t),e=i=>0!==i?i-1:oi.length-1,a=i=>i!==oi.length-1?i+1:0,h=(i,t,s,n,o,e,a,h)=>i*o*h+t*e*a-s*o*a-t*n*h;let l,d,c,r,p,u,f,g,M,x,v,b,A,I,m,P,y,T,B,E,w,H,k,N,R,q,W,S,U,F,_,G,j,z,C,O,X,D,J,K,L;const Q=t.detail*t.detail*10;t.indices=new Uint32Array(t.detail*t.detail*15*3),t.positions=new Float32Array(3*Q),t.setIndex(new THREE.BufferAttribute(t.indices,1)),t.addAttribute("position",new THREE.BufferAttribute(t.positions,3));let V,Y,Z,$,ii,ti,si=0,ni=0,oi=[],ei=[],ai=[],hi=[],li=[],di=[],ci=[],ri=!1,pi=!1;ii=0,ti=0,ui(t.btm,t.div4Btm,-t.phiBtm,1),ui(t.top,t.div4Top,-t.phiTop,-1),t.adapt=[];for(let Hi=0;Hi<t.holes.length;Hi++)3===t.holes[Hi].length?gi(Hi):fi(Hi);for(ii=0,oi=hi[ii];ti>0;)if(ri||pi)ri?(xi(l,b,I,A),r=0,Ti(Y),Ti(Y+1),oi[Y].ang<oi[Y+1].ang?(mi(Y),r+=d-1,Ti(Y+1+r),mi(Y+1+r),r+=d-1):(mi(Y+1),r+=d-1,Ti(Y),mi(Y),r+=d-1),Ti(Z+r),Ti(Z+1+r),oi[Z+r].ang<oi[Z+1+r].ang?(mi(Z+r),r+=d-1,Ti(Z+1+r),mi(Z+1+r)):(mi(Z+1+r),Ti(Z+r),mi(Z+r)),ri=!1):pi&&(bi(x,v),Ai(),pi=!1);else{ci=[];for(let i=0;i<oi.length;i++)0===oi[i].ang&&Ti(i);l=Ii(),mi(l),oi.length>9&&0===ci.length&&(Mi(l),vi(l)),3===oi.length&&(t.indices[ni]=oi[2].idx,t.indices[ni+1]=oi[1].idx,t.indices[ni+2]=oi[0].idx,ni+=3,oi=[],hi[ii]=[],ti-=1,Pi())}function ui(i,s,n,o){const e=t.d/Math.sin(Math.PI/s/4)/2;let a,h,l,d,c,r,p,u;hi[ii]=[],di[ii]=[],a=l=1/0,h=c=i,d=r=-1/0;for(let f=0,g=0;f<t.detail;f++,g+=2*Math.PI/t.detail)m=t.radius*Math.cos(g),P=i+o*(-e+Math.sqrt(e*e-t.radius*t.radius*Math.cos(g)*Math.cos(g))),y=t.radius*Math.sin(o*g),0!==n&&(p=m,u=y,m=p*Math.cos(n)-u*Math.sin(n),y=p*Math.sin(n)+u*Math.cos(n)),t.positions[si]=m,t.positions[si+1]=P,t.positions[si+2]=y,hi[ii].push({idx:si/3,ang:0}),a=m<a?m:a,h=P<h?P:h,l=y<l?y:l,d=m>d?m:d,c=P>c?P:c,r=y>r?y:r,si+=3;di[ii].push(a,d,h,c,l,r),ii++,ti++}function fi(i){let s,e,a,h,l,d,c,r,p,f,g;a=h=l=1/0,d=c=r=-1/0,hi[ii]=[],di[ii]=[],s=t.holes[i][1],w=t.radius*Math.cos(s),H=t.holes[i][0],k=-t.radius*Math.sin(s);for(let M=1;M<t.holes[i].length/2+1;M++){if(t.positions[si]=w,t.positions[si+1]=H,t.positions[si+2]=k,hi[ii].push({idx:si/3,ang:0}),a=w<a?w:a,h=H<h?H:h,l=k<l?k:l,d=w>d?w:d,c=H>c?H:c,r=k>r?k:r,si+=3,s=t.holes[i][M<t.holes[i].length/2?2*M+1:1],N=t.radius*Math.cos(s),R=t.holes[i][M<t.holes[i].length/2?2*M:0],q=-t.radius*Math.sin(s),p=N-w,f=R-H,g=q-k,u=n(p,f,g),u>t.d){e=Math.ceil(u/t.d);for(let i=1;i<e;i++)m=w+i*p/e,P=H+i*f/e,y=k+i*g/e,u=o(m,y),t.positions[si]=t.radius*m/u,t.positions[si+1]=P,t.positions[si+2]=t.radius*y/u,hi[ii].push({idx:si/3,ang:0}),a=m<a?m:a,h=P<h?P:h,l=y<l?y:l,d=m>d?m:d,c=P>c?P:c,r=y>r?y:r,si+=3}w=N,H=R,k=q}di[ii].push(a,d,h,c,l,r),ii++,ti++}function gi(i){let s,n;const o=t.holes[i][0],e=t.holes[i][1],a=t.holes[i][2],h=4*a;let l,d,c,r,p,u;l=d=c=1/0,r=p=u=-1/0;const f=t.d/(2*Math.sin(Math.PI/h));s=f*Math.sin(e),n=f*Math.cos(e),t.adapt.push([s,o,n,f,a]),hi[ii]=[],di[ii]=[];for(let g=0,M=0;g<h;g++,M+=2*Math.PI/h)s=Math.sqrt(t.radius*t.radius-f*f*Math.cos(M)*Math.cos(M)),P=o+f*Math.sin(M),n=f*Math.cos(M),m=s*Math.cos(e)-n*Math.sin(e),y=-s*Math.sin(e)-n*Math.cos(e),t.positions[si]=m,t.positions[si+1]=P,t.positions[si+2]=y,hi[ii].push({idx:si/3,ang:0}),l=m<l?m:l,d=P<d?P:d,c=y<c?y:c,r=m>r?m:r,p=P>p?P:p,u=y>u?y:u,si+=3;di[ii].push(l,r,d,p,c,u),ii++,ti++}function Mi(n){let o,e,a,h,l,d=1/0;ri=!1;for(let c=0;c<ai.length;c++){Ei(n+c);for(let n=0;n<hi.length;n++)if(n!==ii&&(e=T>di[n][0]-t.d&&T<di[n][3]+t.d,a=B>di[n][1]-t.d&&B<di[n][4]+t.d,h=E>di[n][2]-t.d&&E<di[n][5]+t.d,e||a||h))for(let e=0;e<hi[n].length;e++)o=3*hi[n][e].idx,N=t.positions[o],R=t.positions[o+1],q=t.positions[o+2],l=s(N-T,R-B,q-E),l<i&&l<d&&(d=l,b=c,A=e,I=n,ri=!0)}}function xi(i,t,s,n){let o=[];o[0]=oi.slice(0,i+t+1),o[1]=hi[s].slice(n,hi[s].length),o[2]=hi[s].slice(0,n+1),o[3]=oi.slice(i+t,oi.length),Y=i+t,Z=i+t+1+hi[s].length,oi=[];for(let e=0;e<4;e++)for(let i=0;i<o[e].length;i++)oi.push(o[e][i]);hi[s]=[],ti-=1}function vi(n){let o,e,a,h=1/0;pi=!1;for(let l=0;l<oi.length;l++)for(let c=0;c<d;c++)o=n+c,Math.abs(l-o)>3&&Math.abs(l-o)<oi.length-3&&(e=3*oi[o].idx,w=t.positions[e],H=t.positions[e+1],k=t.positions[e+2],Ei(l),a=s(w-T,H-B,k-E),a<i&&a<h&&(h=a,x=l,v=o,pi=!0))}function bi(i,s){let n;oi[i].ang=0,oi[s].ang=0,i>s&&(n=s,s=i,i=n),$=i,ei=[];let o=oi[i],e=oi[s];ei=oi.splice(i+1,s-i-1),ei.unshift(o),ei.push(e),hi.push(ei),function(){let i,s,n,o,e,a,h;li=[],s=n=o=1/0,e=a=h=-1/0;for(let l=0;l<ei.length;l++)i=3*ei[l].idx,m=t.positions[i],P=t.positions[i+1],y=t.positions[i+2],s=m<s?m:s,n=P<n?P:n,o=y<o?y:o,e=m>e?m:e,a=P>a?P:a,h=y>h?y:h;li.push(s,n,o,e,a,h),di.push(li)}(),ti+=1}function Ai(){r=0;let i=$,t=$+1;Ti(i),Ti(t),oi[t].ang<oi[i].ang?(mi(t),r+=d-1,Ti(i),mi(i)):(mi(i),r+=d-1,Ti(t+r),mi(t+r))}function Ii(){let i,t=1/0;for(let s=0;s<oi.length;s++)oi[s].ang<t&&(t=oi[s].ang,i=s);return i}function mi(s){if(ai=[],c=Math.floor(3*oi[s].ang/Math.PI)+1,p=oi[s].ang/c,Bi(s),wi(s),f=n(w-T,H-B,k-E),g=n(N-T,R-B,q-E),M=n(N-w,R-H,q-k),p<.8&&c>1&&(c--,p=oi[s].ang/c),p>.8&&1===c&&M>1.25*t.d&&(c=2,p=oi[s].ang/c),(f*f<.2*i||g*g<.2*i)&&(c=1),d=c-1,0===d)t.indices[ni]=oi[s].idx,t.indices[ni+1]=oi[e(s)].idx,t.indices[ni+2]=oi[a(s)].idx,ni+=3,oi[e(s)].ang=0,oi[a(s)].ang=0,oi.splice(s,1);else{J=T,K=B,L=E;for(let i=0,s=p;i<d;i++,s+=p)T=J+Math.cos(s)*t.d*U+Math.sin(s)*t.d*G,B=K+Math.cos(s)*t.d*F+Math.sin(s)*t.d*j,E=L+Math.cos(s)*t.d*_+Math.sin(s)*t.d*z,u=o(T,E),t.positions[si]=t.radius*T/u,t.positions[si+1]=B,t.positions[si+2]=t.radius*E/u,ai.push({idx:si/3,ang:0}),si+=3;t.indices[ni]=oi[s].idx,t.indices[ni+1]=oi[e(s)].idx,t.indices[ni+2]=ai[0].idx,ni+=3,oi[e(s)].ang=0;for(let i=0;i<d-1;i++)t.indices[ni]=oi[s].idx,t.indices[ni+1]=ai[i].idx,t.indices[ni+2]=ai[i+1].idx,ni+=3;t.indices[ni]=oi[s].idx,t.indices[ni+1]=ai[d-1].idx,t.indices[ni+2]=oi[a(s)].idx,oi[a(s)].ang=0,ni+=3,function(i,t){let s=oi.splice(i,oi.length-i);for(let n=0;n<t.length;n++)oi.push(t[n]);for(let n=1;n<s.length;n++)oi.push(s[n])}(s,ai)}}function Pi(){if(ti>0){for(let i=0;i<hi.length;i++)if(hi[i].length>0){ii=i;break}oi=hi[ii],ci=[];for(let i=0;i<oi.length;i++)Ti(i)}}function yi(i,t){let s=Math.atan2(t,i);return s<0&&(s+=2*Math.PI),s}function Ti(i){let t,s;Bi(i),wi(i),function(){let i=h(U,F,_,G,j,z,W,S);C=h(w-T,H-B,k-E,G,j,z,W,S)/i,O=h(U,F,_,w-T,H-B,k-E,W,S)/i,X=h(N-T,R-B,q-E,G,j,z,W,S)/i,D=h(U,F,_,N-T,R-B,q-E,W,S)/i}(),t=yi(C,O),s=yi(X,D),s<t&&(s+=2*Math.PI),oi[i].ang=s-t,oi[i].ang<1.5&&ci.push(i)}function Bi(i){!function(i){V=3*oi[e(i)].idx,w=t.positions[V],H=t.positions[V+1],k=t.positions[V+2]}(i),Ei(i),u=o(T,E),W=T/u,S=E/u,G=-S*(H-B),j=S*(w-T)-W*(k-E),z=W*(H-B),u=n(G,j,z),G/=u,j/=u,z/=u,U=j*S,F=z*W-G*S,_=-j*W}function Ei(i){V=3*oi[i].idx,T=t.positions[V],B=t.positions[V+1],E=t.positions[V+2]}function wi(i){V=3*oi[a(i)].idx,N=t.positions[V],R=t.positions[V+1],q=t.positions[V+2]}}function e(i){const s=t.d*t.d,n=(i,t,s)=>i*i+t*t+s*s,o=(i,t,s)=>Math.sqrt(i*i+t*t+s*s),e=(i,t)=>Math.sqrt(i*i+t*t),a=i=>0!==i?i-1:at.length-1,h=i=>i!==at.length-1?i+1:0,l=(i,t,s,n,o,e,a,h,l)=>i*o*l+t*e*a+s*n*h-s*o*a-i*e*h-t*n*l;let d,c,r,p,u,f,g,M,x,v,b,A,I,m,P,y,T,B,E,w,H,k,N,R,q,W,S,U,F,_,G,j,z,C,O,X,D,J,K,L,Q,V,Y,Z,$,ii,ti,si,ni,oi,ei,ai,hi,li,di,ci,ri,pi,ui,fi,gi,Mi,xi,vi,bi,Ai,Ii,mi,Pi,yi,Ti,Bi,Ei,wi,Hi,ki,Ni,Ri,qi,Wi,Si,Ui,Fi,_i,Gi,ji,zi,Ci,Oi,Xi,Di,Ji,Ki,Li,Qi,Vi;const Yi=t.detail*t.detail*20;t.indices=new Uint32Array(t.detail*t.detail*30*3),t.positions=new Float32Array(3*Yi),t.setIndex(new THREE.BufferAttribute(t.indices,1)),t.setAttribute("position",new THREE.BufferAttribute(t.positions,3));let Zi,$i,it,tt,st,nt,ot=0,et=0,at=[],ht=[],lt=[],dt=[],ct=[],rt=[],pt=[],ut=[],ft=[],gt=!1,Mt=!1;for(st=0,nt=0,function(){if("circle"===t.surface){qt();for(let i=0,s=0;i<t.detail;i++,s+=2*Math.PI/t.detail)P=t.radius*Math.cos(s),y=0,T=t.radius*Math.sin(s),t.positions[ot]=P,t.positions[ot+1]=y,t.positions[ot+2]=T,dt[st].push({idx:ot/3,ang:0}),Rt(P,y,T),ot+=3;rt[st].push(Y,ii,Z,ti,$,si),st++,nt++}if("polygon"===t.surface){for(let i=0,s=0;i<t.polygonN;i++,s+=2*Math.PI/t.polygonN)ut.push(t.radius*Math.cos(s),t.radius*Math.sin(s));Vt(-1)}if("rectangle"===t.surface&&(ni=t.divW*t.d/2,ei=t.divH*t.d/2,ut=[ni,ei,-ni,ei,-ni,-ei,ni,-ei],Vt(-1)),"outline"===t.surface&&(ut=t.points,Vt(-1)),"circle"===t.surface||"polygon"===t.surface||"rectangle"===t.surface||"outline"===t.surface)for(let i=0;i<t.holes.length;i++)if("circle"===t.holes[i][0]){Xi=t.d/Math.sin(Math.PI/t.holes[i][1]/4)/2,qt();for(let s=0,n=2*Math.PI;s<4*t.holes[i][1];s++,n-=Math.PI/t.holes[i][1]/2)P=Xi*Math.cos(n)+t.holes[i][2],y=0,T=Xi*Math.sin(n)+t.holes[i][3],t.positions[ot]=P,t.positions[ot+1]=y,t.positions[ot+2]=T,dt[st].push({idx:ot/3,ang:0}),Rt(P,y,T),ot+=3;rt[st].push(Y,ii,Z,ti,$,si),st++,nt++}else if("polygon"===t.holes[i][0]){Xi=t.d*t.holes[i][2]/Math.sin(Math.PI/t.holes[i][1])/2;for(let s=0,n=2*Math.PI;s<t.holes[i][1];s++,n-=2*Math.PI/t.holes[i][1])ut.push(Xi*Math.cos(n)+t.holes[i][3],Xi*Math.sin(n)+t.holes[i][4]);Vt(-1)}else"rectangle"===t.holes[i][0]?(ni=t.holes[i][1]*t.d/2,ei=t.holes[i][2]*t.d/2,ai=t.holes[i][3],hi=t.holes[i][4],ut=[ni+ai,-ei+hi,-ni+ai,-ei+hi,-ni+ai,ei+hi,ni+ai,ei+hi],Vt(-1)):Vt(i);if("sphere"===t.surface){t.circles=[];for(let i=0;i<t.holes.length;i++)"circle"===t.holes[i][0]?_t(i):"cylinder"===t.holes[i][0]?Gt(i):Vt(i)}if("planecap"===t.surface&&(Ri=t.tilt,ji=-1,Ui=0,Pi=0,zt()),"cylinder"===t.surface){Ui=t.btm,t.div4Adp=t.div4Btm,Pi=t.phiBtm,Fi="cylinder"===t.geoBtm?t.excBtm:-t.excBtm,Qi=t.excUnitBtm,Ri=t.tiltBtm,zi=!1,ji="plane"===t.geoBtm?-1:1,"plane"===t.geoBtm&&zt(),"sphere"===t.geoBtm&&Ot(),"cylinder"===t.geoBtm&&Dt(),Ui=t.top,t.div4Adp=t.div4Top,Pi=t.phiTop,Fi="cylinder"===t.geoTop?-t.excTop:t.excTop,Qi=t.excUnitTop,Ri=t.tiltTop,zi=!0,ji="cylinder"===t.geoTop?-1:1,"plane"===t.geoTop&&zt(),"sphere"===t.geoTop&&Ot(),"cylinder"===t.geoTop&&Dt();for(let i=0;i<t.holes.length;i++)"sphere"===t.holes[i][0]?Jt(i):"cylinder"===t.holes[i][0]?Lt(i):Vt(i)}}(),0===nt&&function(){switch(t.surface){case"sphere":dt[st]=[],rt[st]=[],xt(0,0),xt(Math.PI/2/t.div4,-Math.PI/6),xt(Math.PI/2/t.div4,Math.PI/6),t.indices[0]=0,t.indices[1]=1,t.indices[2]=2,et+=3,dt[st].push({idx:0,ang:0},{idx:1,ang:0},{idx:2,ang:0}),st++,nt++}}(),st=0,at=dt[st];nt>0;)if(gt||Mt)gt?(bt(d,A,m,I),p=0,wt($i),wt($i+1),at[$i].ang<at[$i+1].ang?(yt($i),p+=c-1,wt($i+1+p),yt($i+1+p),p+=c-1):(yt($i+1),p+=c-1,wt($i),yt($i),p+=c-1),wt(it+p),wt(it+1+p),at[it+p].ang<at[it+1+p].ang?(yt(it+p),p+=c-1,wt(it+1+p),yt(it+1+p)):(yt(it+1+p),wt(it+p),yt(it+p)),gt=!1):Mt&&(It(v,b),mt(),Mt=!1);else{pt=[];for(let i=0;i<at.length;i++)0===at[i].ang&&wt(i);d=Pt(),yt(d),at.length>9&&0===pt.length&&(vt(d),At(d)),3===at.length&&(t.indices[et]=at[2].idx,t.indices[et+1]=at[1].idx,t.indices[et+2]=at[0].idx,et+=3,at=[],dt[st]=[],nt-=1,Bt())}function xt(i,s){t.positions[ot]=t.radius*Math.sin(i)*Math.cos(s),t.positions[ot+1]=t.radius*Math.cos(i),t.positions[ot+2]=-t.radius*Math.sin(i)*Math.sin(s),ot+=3}function vt(i){let o,e,a,h,l,d=1/0;gt=!1;for(let c=0;c<lt.length;c++){kt(i+c);for(let i=0;i<dt.length;i++)if(i!==st&&(e=B>rt[i][0]-t.d&&B<rt[i][3]+t.d,a=E>rt[i][1]-t.d&&E<rt[i][4]+t.d,h=w>rt[i][2]-t.d&&w<rt[i][5]+t.d,e||a||h))for(let e=0;e<dt[i].length;e++)o=3*dt[i][e].idx,R=t.positions[o],q=t.positions[o+1],W=t.positions[o+2],l=n(R-B,q-E,W-w),l<s&&l<d&&(d=l,A=c,I=e,m=i,gt=!0)}}function bt(i,t,s,n){let o=[];o[0]=at.slice(0,i+t+1),o[1]=dt[s].slice(n,dt[s].length),o[2]=dt[s].slice(0,n+1),o[3]=at.slice(i+t,at.length),$i=i+t,it=i+t+1+dt[s].length,at=[];for(let e=0;e<4;e++)for(let i=0;i<o[e].length;i++)at.push(o[e][i]);dt[s]=[],nt-=1}function At(i){let o,e,a,h=1/0;Mt=!1;for(let l=0;l<at.length;l++)for(let d=0;d<c;d++)o=i+d,Math.abs(l-o)>3&&Math.abs(l-o)<at.length-3&&(e=3*at[o].idx,H=t.positions[e],k=t.positions[e+1],N=t.positions[e+2],kt(l),a=n(H-B,k-E,N-w),a<s&&a<h&&(h=a,v=l,b=o,Mt=!0))}function It(i,s){let n;at[i].ang=0,at[s].ang=0,i>s&&(n=s,s=i,i=n),tt=i,ht=[];let o=at[i],e=at[s];ht=at.splice(i+1,s-i-1),ht.unshift(o),ht.push(e),dt.push(ht),function(){let i;ct=[],Y=Z=$=1/0,ii=ti=si=-1/0;for(let s=0;s<ht.length;s++)i=3*ht[s].idx,Rt(t.positions[i],t.positions[i+1],t.positions[i+2]);ct.push(Y,Z,$,ii,ti,si),rt.push(ct)}(),nt+=1}function mt(){p=0;let i=tt,t=tt+1;wt(i),wt(t),at[t].ang<at[i].ang?(yt(t),p+=c-1,wt(i),yt(i)):(yt(i),p+=c-1,wt(t+p),yt(t+p))}function Pt(){let i,t=1/0;for(let s=0;s<at.length;s++)at[s].ang<t&&(t=at[s].ang,i=s);return i}function yt(i){if(lt=[],r=Math.floor(3*at[i].ang/Math.PI)+1,u=at[i].ang/r,Ht(i),Nt(i),g=o(H-B,k-E,N-w),M=o(R-B,q-E,W-w),x=o(R-H,q-k,W-N),u<.8&&r>1&&(r--,u=at[i].ang/r),u>.8&&1===r&&x>1.25*t.d&&(r=2,u=at[i].ang/r),(g*g<.2*s||M*M<.2*s)&&(r=1),c=r-1,0===c)t.indices[et]=at[i].idx,t.indices[et+1]=at[a(i)].idx,t.indices[et+2]=at[h(i)].idx,et+=3,at[a(i)].ang=0,at[h(i)].ang=0,at.splice(i,1);else{L=B,Q=E,V=w;for(let i=0,s=u;i<c;i++,s+=u)B=L+Math.cos(s)*t.d*_+Math.sin(s)*t.d*z,E=Q+Math.cos(s)*t.d*G+Math.sin(s)*t.d*C,w=V+Math.cos(s)*t.d*j+Math.sin(s)*t.d*O,Tt(),lt.push({idx:ot/3,ang:0}),ot+=3;t.indices[et]=at[i].idx,t.indices[et+1]=at[a(i)].idx,t.indices[et+2]=lt[0].idx,et+=3,at[a(i)].ang=0;for(let s=0;s<c-1;s++)t.indices[et]=at[i].idx,t.indices[et+1]=lt[s].idx,t.indices[et+2]=lt[s+1].idx,et+=3;t.indices[et]=at[i].idx,t.indices[et+1]=lt[c-1].idx,t.indices[et+2]=at[h(i)].idx,at[h(i)].ang=0,et+=3,function(i,t){let s=at.splice(i,at.length-i);for(let n=0;n<t.length;n++)at.push(t[n]);for(let n=1;n<s.length;n++)at.push(s[n])}(i,lt)}}function Tt(){switch(t.surface){case"polygon":case"outline":case"rectangle":case"circle":t.positions[ot]=B,t.positions[ot+1]=0,t.positions[ot+2]=w;break;case"sphere":f=o(B,E,w),t.positions[ot]=t.radius*B/f,t.positions[ot+1]=t.radius*E/f,t.positions[ot+2]=t.radius*w/f;break;case"planecap":t.positions[ot]=B,t.positions[ot+1]=E,t.positions[ot+2]=w;break;case"cylinder":f=e(B,w),t.positions[ot]=t.radius*B/f,t.positions[ot+1]=E,t.positions[ot+2]=t.radius*w/f}}function Bt(){if(nt>0){for(let i=0;i<dt.length;i++)if(dt[i].length>0){st=i;break}at=dt[st],pt=[];for(let i=0;i<at.length;i++)wt(i)}}function Et(i,t){let s=Math.atan2(t,i);return s<0&&(s+=2*Math.PI),s}function wt(i){let t,s;Ht(i),Nt(i),function(){let i=l(_,G,j,z,C,O,S,U,F);X=l(H-B,k-E,N-w,z,C,O,S,U,F)/i,D=l(_,G,j,H-B,k-E,N-w,S,U,F)/i,J=l(R-B,q-E,W-w,z,C,O,S,U,F)/i,K=l(_,G,j,R-B,q-E,W-w,S,U,F)/i}(),t=Et(X,D),s=Et(J,K),s<t&&(s+=2*Math.PI),at[i].ang=s-t,at[i].ang<1.5&&pt.push(i)}function Ht(i){switch(function(i){Zi=3*at[a(i)].idx,H=t.positions[Zi],k=t.positions[Zi+1],N=t.positions[Zi+2]}(i),kt(i),t.surface){case"polygon":case"outline":case"rectangle":case"circle":S=0,U=1,F=0,_=H-B,G=0,j=N-w,f=o(_,G,j),_/=f,G=0,j/=f,z=j,C=0,O=-_;break;case"sphere":f=o(B,E,w),S=B/f,U=E/f,F=w/f,Ii=Math.abs(H*B+k*E+N*w)/t.radius,L=Ii/t.radius*B,Q=Ii/t.radius*E,V=Ii/t.radius*w,_=H-L,G=k-Q,j=N-V,f=o(_,G,j),_/=f,G/=f,j/=f,z=U*j-F*G,C=F*_-S*j,O=S*G-U*_;break;case"planecap":S=-t.sintilt,U=t.costilt,F=0,_=H-B,G=k-E,j=N-w,f=o(_,G,j),_/=f,G/=f,j/=f,z=U*j-F*G,C=F*_-S*j,O=S*G-U*_;break;case"cylinder":f=e(B,w),S=B/f,U=0,F=w/f,z=-F*(k-E),C=F*(H-B)-S*(N-w),O=S*(k-E),f=o(z,C,O),z/=f,C/=f,O/=f,_=C*F,G=O*S-z*F,j=-C*S}}function kt(i){Zi=3*at[i].idx,B=t.positions[Zi],E=t.positions[Zi+1],w=t.positions[Zi+2]}function Nt(i){Zi=3*at[h(i)].idx,R=t.positions[Zi],q=t.positions[Zi+1],W=t.positions[Zi+2]}function Rt(i,t,s){i<Y&&(Y=i),t<Z&&(Z=t),s<$&&($=s),i>ii&&(ii=i),t>ti&&(ti=t),s>si&&(si=s)}function qt(){Y=Z=$=1/0,ii=ti=si=-1/0,dt[st]=[],rt[st]=[]}function Wt(){for(let i=Ai-3;i>-1;i-=3)ft.push(ft[i],ft[i+1],ft[i+2]);ft.splice(0,Ai)}function St(i){for(yi=wi,Bi=2*Math.PI/Math.max(t.detail,t.detailAdp)/16,bi=1/0,i(),ft.push(P,y,T),ni=P,oi=y,ei=T,yi=Hi,i(),yi=wi,H=P,k=y,N=T;ji>0?yi<Hi&&(bi>5.76*s||yi<(wi+Hi)/2):yi>Hi&&(bi>5.76*s||yi>(wi+Hi)/2);){for(Ti=yi,vi=0;vi<.81*s;)yi+=ji*Bi,i(),ui=P-ni,fi=y-oi,gi=T-ei,vi=n(ui,fi,gi);ft.push(P,y,T),"dx"===Oi?(Mi=Math.abs(Math.sqrt(fi*fi+gi*gi)/ui),Mi=Mi>1?1:Mi,Bi=Math.abs(yi-Ti)*Mi/16):(xi=Math.abs(Math.sqrt(ui*ui+gi*gi)/fi),xi=xi>1?1:xi,Bi=Math.abs(yi-Ti)*xi/16),ni=P,oi=y,ei=T,ui=P-H,fi=y-k,gi=T-N,bi=n(ui,fi,gi)}bi>1.44*s&&(yi+=(Hi-yi)/2,i(),ft.push(P,y,T)),Ci&&ft.push(H,k,N)}function Ut(i){li=ft[i],di=ft[i+1],ci=ft[i+2],ri=li*Math.cos(mi)+di*Math.sin(mi),pi=-li*Math.sin(mi)+di*Math.cos(mi),P=ri*Math.cos(Pi)+ci*Math.sin(Pi),T=-ri*Math.sin(Pi)+ci*Math.cos(Pi),y=pi,t.positions[ot]=P,t.positions[ot+1]=y,t.positions[ot+2]=T,dt[st].push({idx:ot/3,ang:0}),Rt(P,y,T),ot+=3}function Ft(){qt();for(let i=0;i<ft.length;i+=3)li=ft[i],di=ft[i+1],ci=ft[i+2],P=li*Math.cos(Pi)-ci*Math.sin(Pi),T=li*Math.sin(Pi)+ci*Math.cos(Pi),y=di+Ui,t.positions[ot]=P,t.positions[ot+1]=y,t.positions[ot+2]=T,dt[st].push({idx:ot/3,ang:0}),Rt(P,y,T),ot+=3;rt[st].push(Y,ii,Z,ti,$,si),st++,nt++}function _t(i){t.div4Adp=t.holes[i][1],mi=t.holes[i][2],Pi=t.holes[i][3],t.detailAdp=4*t.div4Adp,t.rAdp=t.d/Math.sin(Math.PI/t.detailAdp)/2,Ii=Math.sqrt(t.radius*t.radius-t.rAdp*t.rAdp),B=t.radius*Math.sin(mi)*Math.cos(Pi),E=t.radius*Math.cos(mi),w=-t.radius*-Math.sin(mi)*Math.sin(Pi),L=Ii/t.radius*B,Q=Ii/t.radius*E,V=Ii/t.radius*w,t.circles.push([t.div4Adp,L,Q,V,t.rAdp]),qt(),di=Ii;for(let s=0,n=0;s<t.detailAdp;s++,n+=2*Math.PI/t.detailAdp)li=t.rAdp*Math.cos(n),ci=t.rAdp*Math.sin(n),ri=li*Math.cos(mi)-di*Math.sin(mi),pi=li*Math.sin(mi)+di*Math.cos(mi),P=-ri*Math.cos(Pi)+ci*Math.sin(Pi),T=ri*Math.sin(Pi)+ci*Math.cos(Pi),y=pi,t.positions[ot]=P,t.positions[ot+1]=y,t.positions[ot+2]=T,dt[st].push({idx:ot/3,ang:0}),Rt(P,y,T),ot+=3;rt[st].push(Y,ii,Z,ti,$,si),st++,nt++}function Gt(i){switch(t.div4Adp=t.holes[i][1],mi=t.holes[i][2],Pi=t.holes[i][3],Qi=t.holes[i][5],Gi=void 0!==t.holes[i][6]?t.holes[i][6]:"+",Qi){case"%":Fi=t.holes[i][4]/100*t.radius;break;case"d":Fi=t.holes[i][4]*t.d;break;case"v":Fi=t.holes[i][4];break;default:Fi=t.holes[i][4]}if(Fi=0===Fi?1e-9:Fi,t.detailAdp=4*t.div4Adp,t.rAdp=t.d/Math.sin(Math.PI/t.detailAdp)/2,t.radius+t.rAdp-Fi>0){if(Ki=t.radius*t.radius-t.rAdp*t.rAdp-Fi*Fi,ji=1,wi=Math.PI,Ci=!0,Oi="dy",ft=[],t.rAdp+Fi<=t.radius?(Hi=2*Math.PI,Li=!1):(Hi=wi+Math.acos(Ki/(-2*t.rAdp*Fi)),Li=!0),St(jt),Ai=ft.length,Li){for(let i=Ai-6;i>-1;i-=3)ft.push(ft[i],-ft[i+1],ft[i+2]);Ai=ft.length;for(let i=3;i<2*Ai-3;i+=6)ft.unshift(ft[i],ft[i+1],-ft[i+2])}else for(let i=3;i<2*Ai-9;i+=6)ft.unshift(ft[i],ft[i+1],-ft[i+2]);if(Li||!Li&&("+"===Gi||"+-"===Gi||"-+"===Gi)){qt();for(let i=ft.length-3;i>-1;i-=3)Ut(i);rt[st].push(Y,ii,Z,ti,$,si),st++,nt++}if(!Li&&("-"===Gi||"+-"===Gi||"-+"===Gi)){qt();for(let i=0;i<ft.length;i+=3)ft[i+1]=-ft[i+1];for(let i=0;i<ft.length;i+=3)Ut(i);rt[st].push(Y,ii,Z,ti,$,si),st++,nt++}}}function jt(){Ji=Ki-2*t.rAdp*Fi*Math.cos(yi),Ji=Ji>0?Ji:0,P=t.rAdp*Math.cos(yi)+Fi,y=Math.sqrt(Ji),T=t.rAdp*Math.sin(yi)}function zt(){Si=Math.tan(Ri),t.detailAdp=t.detail,wi=ji<0?2*Math.PI:0,Hi=ji<0?0:2*Math.PI,Ci=!1,Oi="dy",ft=[],St(Ct),Ai=ft.length,ji<0&&"btm"!==t.cap&&Wt(),Ft()}function Ct(){P=t.radius*Math.cos(yi),y=t.radius*Math.cos(yi)*Si,T=t.radius*Math.sin(ji*yi),"btm"!==t.cap&&(T=-T)}function Ot(){"%"===Qi&&(Fi=Fi/100*t.radius),"d"===Qi&&(Fi*=t.d),t.detailAdp=4*t.div4Adp,t.rAdp=t.d/Math.sin(Math.PI/t.detailAdp)/2,Ki=t.rAdp*t.rAdp-t.radius*t.radius-Fi*Fi,wi=Math.PI,Hi=2*Math.PI,Ci=!0,Oi="dy",ft=[],St(Xt),Ai=ft.length;for(let i=3;i<2*Ai-9;i+=6)ft.unshift(ft[i],ft[i+1],-ft[i+2]);if(Ai=ft.length,zi){for(let i=1;i<Ai;i+=3)ft[i]=-ft[i];Wt()}Ft()}function Xt(){Ji=Ki-2*t.radius*Fi*Math.cos(yi),Ji=Ji>0?Ji:0,P=t.radius*Math.cos(yi),y=Math.sqrt(Ji)-t.rAdp,T=t.radius*Math.sin(yi)}function Dt(){"%"===Qi&&(Fi=Fi/100*t.radius),"d"===Qi&&(Fi*=t.d),Ri=Math.PI/2-Ri,t.detailAdp=4*t.div4Adp,t.rAdp=t.d/Math.sin(Math.PI/t.detailAdp)/2,qi=Math.sin(Ri),qi=0===qi?1e-9:qi,Wi=Math.cos(Ri),wi=-ji*Math.PI,Hi=ji*Math.PI,Ci=!1,Oi="dx",ft=[],Xi=t.radius,Di=t.rAdp,St(Qt),Ai=ft.length,Wt(),qt();for(let i=0;i<ft.length;i+=3)li=ft[i],di=ft[i+1],ci=ft[i+2],ri=li*Wi-di*qi,pi=li*qi+di*Wi,ci+=Fi,pi-=ji*t.rAdp/qi,P=ri*Math.cos(Pi)-ci*Math.sin(Pi),T=ri*Math.sin(Pi)+ci*Math.cos(Pi),y=pi+Ui,t.positions[ot]=P,t.positions[ot+1]=y,t.positions[ot+2]=T,dt[st].push({idx:ot/3,ang:0}),Rt(P,y,T),ot+=3;rt[st].push(Y,ii,Z,ti,$,si),st++,nt++}function Jt(i){switch(t.div4Adp=t.holes[i][1],Ui=t.holes[i][2],Pi=-(Math.PI+t.holes[i][3]),Qi=t.holes[i][5],t.detailAdp=4*t.div4Adp,t.rAdp=t.d/Math.sin(Math.PI/t.detailAdp)/2,Qi){case"%":Fi=t.holes[i][4]/100*t.radius;break;case"d":Fi=t.holes[i][4]*t.d;break;case"v":Fi=t.holes[i][4];break;default:Fi=t.holes[i][4]}if(Fi=0===Fi?1e-13:Fi,t.radius+t.rAdp-Fi>0){Ki=t.rAdp*t.rAdp-t.radius*t.radius-Fi*Fi,ji=1,wi=Math.PI,Hi=wi+Math.acos(Ki/(-2*t.radius*Fi)),Ci=!0,Oi="dy",ft=[],St(Kt),Ai=ft.length;for(let i=Ai-6;i>-1;i-=3)ft.push(ft[i],-ft[i+1],ft[i+2]);Ai=ft.length;for(let i=3;i<2*Ai-3;i+=6)ft.unshift(ft[i],ft[i+1],-ft[i+2]);Ft()}}function Kt(){Ji=Ki-2*t.radius*Fi*Math.cos(yi),P=t.radius*Math.cos(yi),y=Math.sqrt(Ji),T=t.radius*Math.sin(yi)}function Lt(i){switch(t.div4Adp=t.holes[i][1],Ui=t.holes[i][2],Pi=-t.holes[i][3],Qi=t.holes[i][5],Ri=Math.PI/2-t.holes[i][6],Gi=void 0!==t.holes[i][7]?t.holes[i][7]:"+",Qi){case"%":Fi=t.holes[i][4]/100*t.radius;break;case"d":Fi=t.holes[i][4]*t.d;break;case"v":Fi=t.holes[i][4];break;default:Fi=t.holes[i][4]}if(t.detailAdp=4*t.div4Adp,t.rAdp=t.d/Math.sin(Math.PI/t.detailAdp)/2,t.radius+t.rAdp-Fi>0){if(qi=Math.sin(Ri),qi=0===qi?1e-9:qi,Wi=Math.cos(Ri),Xi=Math.min(t.rAdp,t.radius),Di=Math.max(t.rAdp,t.radius),Xi+Fi>Di){Ei=Math.acos((Di-Fi)/Xi),ji=1,wi=Ei,Hi=2*Math.PI-Ei,Ci=!1,Oi="dx",ft=[],St(Qt),ji=-1,wi=2*Math.PI-Ei,Hi=Ei,Ci=!1,St(Qt),qt(),Ai=ft.length,t.rAdp>t.radius&&Wt();for(let i=0;i<Ai;i+=3)li=ft[i],di=ft[i+1],ci=ft[i+2],t.rAdp>t.radius&&(ri=li*Wi-di*qi,pi=li*qi+di*Wi,li=ri,di=pi,ci+=Fi),P=li*Math.cos(Pi)-ci*Math.sin(Pi),T=li*Math.sin(Pi)+ci*Math.cos(Pi),y=di+Ui,t.positions[ot]=P,t.positions[ot+1]=y,t.positions[ot+2]=T,dt[st].push({idx:ot/3,ang:0}),Rt(P,y,T),ot+=3;rt[st].push(Y,ii,Z,ti,$,si),st++,nt++}Xi+Fi<=Di&&("+"===Gi||"+-"===Gi||"-+"===Gi)&&(ji=1,wi=-Math.PI,Hi=Math.PI,Ci=!1,Oi="dx",ft=[],St(Qt),Ft()),Xi+Fi<=Di&&("-"===Gi||"+-"===Gi||"-+"===Gi)&&(ji=-1,wi=Math.PI,Hi=-Math.PI,Ci=!1,Oi="dx",ft=[],St(Qt),Ft())}}function Qt(){ki=Math.sin(yi),Ni=Math.cos(yi),Ji=Di*Di-(Fi+Xi*Ni)*(Fi+Xi*Ni),Vi=(Xi*ki*Wi+ji*Math.sqrt(Ji))/qi,P=Vi*qi-Xi*ki*Wi,y=Vi*Wi+Xi*ki*qi,T=-(Fi+Xi*Ni)}function Vt(i){let s;switch(qt(),t.surface){case"circle":case"polygon":case"rectangle":case"outline":s=(i<0?ut.length:t.holes[i].length)/2+1,H=i<0?ut[0]:t.holes[i][0],k=0,N=i<0?ut[1]:t.holes[i][1];break;case"sphere":s=t.holes[i].length/2+1,mi=t.holes[i][0],Pi=t.holes[i][1],H=t.radius*Math.sin(mi)*Math.cos(Pi),k=t.radius*Math.cos(mi),N=-t.radius*Math.sin(mi)*Math.sin(Pi);break;case"cylinder":s=t.holes[i].length/2+1,Ui=t.holes[i][0],Pi=t.holes[i][1],H=t.radius*Math.cos(Pi),k=Ui,N=-t.radius*Math.sin(Pi)}for(let n=1;n<s;n++){switch(t.positions[ot]=H,t.positions[ot+1]=k,t.positions[ot+2]=N,dt[st].push({idx:ot/3,ang:0}),Rt(H,k,N),ot+=3,t.surface){case"circle":case"polygon":case"rectangle":case"outline":R=i<0?ut[n<s-1?2*n:0]:t.holes[i][n<s-1?2*n:0],q=0,W=i<0?ut[n<s-1?2*n+1:1]:t.holes[i][n<s-1?2*n+1:1];break;case"sphere":mi=t.holes[i][n<t.holes[i].length/2?2*n:0],Pi=t.holes[i][n<t.holes[i].length/2?2*n+1:1],R=t.radius*Math.sin(mi)*Math.cos(Pi),q=t.radius*Math.cos(mi),W=-t.radius*Math.sin(mi)*Math.sin(Pi);break;case"cylinder":Pi=t.holes[i][n<t.holes[i].length/2?2*n+1:1],R=t.radius*Math.cos(Pi),q=t.holes[i][n<t.holes[i].length/2?2*n:0],W=-t.radius*Math.sin(Pi)}if(ui=R-H,fi=q-k,gi=W-N,f=o(ui,fi,gi),f>t.d){_i=Math.ceil(f/t.d);for(let i=1;i<_i;i++)B=H+i*ui/_i,E=k+i*fi/_i,w=N+i*gi/_i,Tt(),dt[st].push({idx:ot/3,ang:0}),Rt(B,E,w),ot+=3}H=R,k=q,N=W}rt[st].push(Y,ii,Z,ti,$,si),st++,nt++,ut=[]}}function a(){0===t.b.length?function(i,s,n,o,e,a,h,l,d,c,r){const p=(i,t,s)=>i*i+t*t+s*s,u=(i,t,s)=>Math.sqrt(i*i+t*t+s*s),f=i=>0!==i?i-1:di.length-1,g=i=>i!==di.length-1?i+1:0,M=(i,t,s,n,o,e,a,h,l)=>i*o*l+t*e*a+s*n*h-s*o*a-i*e*h-t*n*l;let x,v,b,A,I,m,P,y,T,B,E,w,H,k,N,R,q,W,S,U,F,_,G,j,z,C,O,X,D,J,K,L,Q,V,Y,Z,$,ii,ti,si;t.indices=new Uint32Array(3*c),t.positions=new Float32Array(3*r),t.normals=new Float32Array(3*r),t.setIndex(new THREE.BufferAttribute(t.indices,1)),t.addAttribute("position",new THREE.BufferAttribute(t.positions,3)),t.addAttribute("normal",new THREE.BufferAttribute(t.normals,3));let ni,oi,ei,ai,hi=0,li=0,di=[],ci=[],ri=[],pi=[],ui=[],fi=[],gi=[],Mi=!1,xi=!1,vi=l*l;pi.push([]),fi.push([]);let bi=0,Ai=0;for(di=pi[Ai],function(){R=e,q=a,W=h,ki(),t.positions[hi]=R,t.positions[hi+1]=q,t.positions[hi+2]=W,t.normals[hi]=z,t.normals[hi+1]=C,t.normals[hi+2]=O,di.push({idx:hi/3,ang:0}),hi+=3,S=e+l/32,U=a+l/32,F=h+l/32,Wi(),ii=R,ti=q,si=W,m=0;for(let i=0;i<2;i++)Hi(),di.push({idx:hi/3,ang:0}),hi+=3,m+=Math.PI/3;t.indices[li]=0,t.indices[li+1]=1,t.indices[li+2]=2,li+=3,bi+=1}();bi>0;)if(Mi||xi)Mi?(mi(x,H,N,k),A=0,qi(oi),qi(oi+1),di[oi].ang<di[oi+1].ang?(Ei(oi),A+=v-1,qi(oi+1+A),Ei(oi+1+A),A+=v-1):(Ei(oi+1),A+=v-1,qi(oi),Ei(oi),A+=v-1),qi(ei+A),qi(ei+1+A),di[ei+A].ang<di[ei+1+A].ang?(Ei(ei+A),A+=v-1,qi(ei+1+A),Ei(ei+1+A)):(Ei(ei+1+A),qi(ei+A),Ei(ei+A)),Mi=!1):xi&&(yi(E,w),Ti(),xi=!1);else{gi=[];for(let i=0;i<di.length;i++)0===di[i].ang&&qi(i);x=Bi(),Ei(x),di.length>9&&0===gi.length&&(Ii(x),Pi(x)),3===di.length&&(t.indices[li]=di[2].idx,t.indices[li+1]=di[1].idx,t.indices[li+2]=di[0].idx,li+=3,di=[],pi[Ai]=[],bi-=1,wi())}function Ii(i){let s,n,o,e,a,h=1/0;Mi=!1;for(let d=0;d<ri.length;d++){Ui(i+d);for(let i=0;i<pi.length;i++)if(i!==Ai&&(n=R>fi[i][0]-l&&R<fi[i][3]+l,o=q>fi[i][1]-l&&q<fi[i][4]+l,e=W>fi[i][2]-l&&W<fi[i][5]+l,n||o||e))for(let n=0;n<pi[i].length;n++)s=3*pi[i][n].idx,_=t.positions[s],G=t.positions[s+1],j=t.positions[s+2],a=p(_-R,G-q,j-W),a<vi&&a<h&&(h=a,H=d,k=n,N=i,Mi=!0)}}function mi(i,t,s,n){let o=[];o[0]=di.slice(0,i+t+1),o[1]=pi[s].slice(n,pi[s].length),o[2]=pi[s].slice(0,n+1),o[3]=di.slice(i+t,di.length),oi=i+t,ei=i+t+1+pi[s].length,di=[];for(let e=0;e<4;e++)for(let i=0;i<o[e].length;i++)di.push(o[e][i]);pi[s]=[],bi-=1}function Pi(i){let s,n,o,e=1/0;xi=!1;for(let a=0;a<di.length;a++)for(let h=0;h<v;h++)s=i+h,Math.abs(a-s)>3&&Math.abs(a-s)<di.length-3&&(n=3*di[s].idx,S=t.positions[n],U=t.positions[n+1],F=t.positions[n+2],Ui(a),o=p(S-R,U-q,F-W),o<vi&&o<e&&(e=o,E=a,w=s,xi=!0))}function yi(i,s){let n;di[i].ang=0,di[s].ang=0,i>s&&(n=s,s=i,i=n),ai=i,ci=[];let o=di[i],e=di[s];ci=di.splice(i+1,s-i-1),ci.unshift(o),ci.push(e),pi.push(ci),function(){let i,s,n,o,e,a,h,l,d,c;ui=[],e=a=h=1/0,l=d=c=-1/0;for(let r=0;r<ci.length;r++)o=3*ci[r].idx,i=t.positions[o],s=t.positions[o+1],n=t.positions[o+2],e=i<e?i:e,a=s<a?s:a,h=n<h?n:h,l=i>l?i:l,d=s>d?s:d,c=n>c?n:c;ui.push(e,a,h,l,d,c),fi.push(ui)}(),bi+=1}function Ti(){A=0;let i=ai,t=ai+1;qi(i),qi(t),di[t].ang<di[i].ang?(Ei(t),A+=v-1,qi(i),Ei(i)):(Ei(i),A+=v-1,qi(t+A),Ei(t+A))}function Bi(){let i,t=1/0;for(let s=0;s<di.length;s++)di[s].ang<t&&(t=di[s].ang,i=s);return i}function Ei(i){if(ri=[],b=Math.floor(3*di[i].ang/Math.PI)+1,I=di[i].ang/b,Si(i),Ui(i),Fi(i),ni=3*di[i].idx,z=t.normals[ni],C=t.normals[ni+1],O=t.normals[ni+2],Wi(),y=u(S-R,U-q,F-W),T=u(_-R,G-q,j-W),B=u(_-S,G-U,j-F),I<.8&&b>1&&(b--,I=di[i].ang/b),I>.8&&1===b&&B>1.25*l&&(b=2,I=di[i].ang/b),(y*y<.2*l*l||T*T<.2*l*l)&&(b=1),v=b-1,0===v)t.indices[li]=di[i].idx,t.indices[li+1]=di[f(i)].idx,t.indices[li+2]=di[g(i)].idx,li+=3,di[f(i)].ang=0,di[g(i)].ang=0,di.splice(i,1);else{ii=R,ti=q,si=W,m=I;for(let i=0;i<v;i++)Hi(),ri.push({idx:hi/3,ang:0}),hi+=3,m+=I;t.indices[li]=di[i].idx,t.indices[li+1]=di[f(i)].idx,t.indices[li+2]=ri[0].idx,li+=3,di[f(i)].ang=0;for(let s=0;s<v-1;s++)t.indices[li]=di[i].idx,t.indices[li+1]=ri[s].idx,t.indices[li+2]=ri[s+1].idx,li+=3;t.indices[li]=di[i].idx,t.indices[li+1]=ri[v-1].idx,t.indices[li+2]=di[g(i)].idx,di[g(i)].ang=0,li+=3,function(i,t){let s=di.splice(i,di.length-i);for(let n=0;n<t.length;n++)di.push(t[n]);for(let n=1;n<s.length;n++)di.push(s[n])}(i,ri)}}function wi(){if(bi>0){for(let i=0;i<pi.length;i++)if(pi[i].length>0){Ai=i;break}di=pi[Ai],gi=[];for(let i=0;i<di.length;i++)qi(i)}}function Hi(){R=ii+Math.cos(m)*l*X+Math.sin(m)*l*K,q=ti+Math.cos(m)*l*D+Math.sin(m)*l*L,W=si+Math.cos(m)*l*J+Math.sin(m)*l*Q,ki(),t.positions[hi]=R,t.positions[hi+1]=q,t.positions[hi+2]=W,t.normals[hi]=z,t.normals[hi+1]=C,t.normals[hi+2]=O}function ki(){let i,t,s;for(i=R,t=q,s=W,Ni();u(i-R,t-q,s-W)>d;)i=R,t=q,s=W,Ni();P=u(z,C,O),z/=P,C/=P,O/=P}function Ni(){let t,e;z=s(R,q,W),C=n(R,q,W),O=o(R,q,W),t=z*z+C*C+O*O,t>d*d?e=-i(R,q,W)/t:(e=0,console.log("WARNING tri (surface_point...): newton")),R+=e*z,q+=e*C,W+=e*O}function Ri(i,t){let s=Math.atan2(t,i);return s<0&&(s+=2*Math.PI),s}function qi(i){let t,s;Si(i),Ui(i),Fi(i),function(){let i=M(X,D,J,K,L,Q,z,C,O);V=M(S-R,U-q,F-W,K,L,Q,z,C,O)/i,Y=M(X,D,J,S-R,U-q,F-W,z,C,O)/i,Z=M(_-R,G-q,j-W,K,L,Q,z,C,O)/i,$=M(X,D,J,_-R,G-q,j-W,z,C,O)/i}(),t=Ri(V,Y),s=Ri(Z,$),s<t&&(s+=2*Math.PI),di[i].ang=s-t,di[i].ang<1.5&&gi.push(i)}function Wi(){K=C*(F-W)-O*(U-q),L=O*(S-R)-z*(F-W),Q=z*(U-q)-C*(S-R),P=u(K,L,Q),K/=P,L/=P,Q/=P,X=L*O-Q*C,D=Q*z-K*O,J=K*C-L*z}function Si(i){ni=3*di[f(i)].idx,S=t.positions[ni],U=t.positions[ni+1],F=t.positions[ni+2]}function Ui(i){ni=3*di[i].idx,R=t.positions[ni],q=t.positions[ni+1],W=t.positions[ni+2]}function Fi(i){ni=3*di[g(i)].idx,_=t.positions[ni],G=t.positions[ni+1],j=t.positions[ni+2]}}(t.isf,t.dx,t.dy,t.dz,t.xs,t.ys,t.zs,t.d,t.e,t.fc,t.pc):function(i,s,n,o,e,a,h,l,d,c,r,p){let u=p;const f=(i,t,s)=>i*i+t*t+s*s,g=(i,t,s)=>Math.sqrt(i*i+t*t+s*s),M=i=>0!==i?i-1:pi.length-1,x=i=>i!==pi.length-1?i+1:0,v=(i,t,s,n,o,e,a,h,l)=>i*o*l+t*e*a+s*n*h-s*o*a-i*e*h-t*n*l;let b,A,I,m,P,y,T,B,E,w,H,k,N,R,q,W,S,U,F,_,G,j,z,C,O,X,D,J,K,L,Q,V,Y,Z,$,ii,ti,si,ni,oi,ei=!1;t.indices=new Uint32Array(3*c),t.positions=new Float32Array(3*r),t.normals=new Float32Array(3*r),t.setIndex(new THREE.BufferAttribute(t.indices,1)),t.addAttribute("position",new THREE.BufferAttribute(t.positions,3)),t.addAttribute("normal",new THREE.BufferAttribute(t.normals,3));let ai,hi,li,di,ci=0,ri=0,pi=[],ui=[],fi=[],gi=[],Mi=[],xi=[],vi=[],bi=!1,Ai=!1,Ii=l*l;gi.push([]),xi.push([]);let mi,Pi=0,yi=0;for(pi=gi[yi],function(){W=e,S=a,U=h,Wi(),t.positions[ci]=W,t.positions[ci+1]=S,t.positions[ci+2]=U,t.normals[ci]=O,t.normals[ci+1]=X,t.normals[ci+2]=D,pi.push({idx:ci/3,ang:0,bou:!1}),ci+=3,F=e+l/32,_=a+l/32,G=h+l/32,_i(),si=W,ni=S,oi=U,y=0;for(let i=0;i<2;i++)qi(),pi.push({idx:ci/3,ang:0,bou:!1}),ci+=3,y+=Math.PI/3;t.indices[ri]=0,t.indices[ri+1]=1,t.indices[ri+2]=2,ri+=3,Pi+=1}();Pi>0;)if(bi||Ai)bi?(Bi(b,N,q,R),m=0,Fi(hi),Fi(hi+1),pi[hi].ang<pi[hi+1].ang?(Ni(hi),m+=A-1,Fi(hi+1+m),Ni(hi+1+m),m+=A-1):(Ni(hi+1),m+=A-1,Fi(hi),Ni(hi),m+=A-1),Fi(li+m),Fi(li+1+m),pi[li+m].ang<pi[li+1+m].ang?(Ni(li+m),m+=A-1,Fi(li+1+m),Ni(li+1+m)):(Ni(li+1+m),Fi(li+m),Ni(li+m)),bi=!1):Ai&&(wi(H,k),Hi(),Ai=!1);else{vi=[];for(let i=0;i<pi.length;i++)0!==pi[i].ang||pi[i].bou||Fi(i);b=ki(),Ni(b),pi.length>9&&0===vi.length&&(Ti(b),Ei(b)),mi=0;for(let i=0;i<pi.length;i++)pi[i].bou||mi++;3!==pi.length&&0!==mi||(3===pi.length&&(t.indices[ri]=pi[2].idx,t.indices[ri+1]=pi[1].idx,t.indices[ri+2]=pi[0].idx,ri+=3,pi=[],gi[yi]=[],Pi-=1),pi=[],gi[yi]=[],Pi-=1,Ri())}function Ti(i){let s,n,o,e,a,h=1/0;bi=!1;for(let d=0;d<fi.length;d++)if(!pi[i+d].bou){ji(i+d);for(let i=0;i<gi.length;i++)if(i!==yi&&(n=W>xi[i][0]-l&&W<xi[i][3]+l,o=S>xi[i][1]-l&&S<xi[i][4]+l,e=U>xi[i][2]-l&&U<xi[i][5]+l,n||o||e))for(let n=0;n<gi[i].length;n++)gi[i][n].bou||(s=3*gi[i][n].idx,j=t.positions[s],z=t.positions[s+1],C=t.positions[s+2],a=f(j-W,z-S,C-U),a<Ii&&a<h&&(h=a,N=d,R=n,q=i,bi=!0))}}function Bi(i,t,s,n){let o=[];o[0]=pi.slice(0,i+t+1),o[1]=gi[s].slice(n,gi[s].length),o[2]=gi[s].slice(0,n+1),o[3]=pi.slice(i+t,pi.length),hi=i+t,li=i+t+1+gi[s].length,pi=[];for(let e=0;e<4;e++)for(let i=0;i<o[e].length;i++)pi.push(o[e][i]);gi[s]=[],Pi-=1}function Ei(i){let s,n,o,e=1/0;Ai=!1;for(let a=0;a<pi.length;a++)if(!pi[a].bou)for(let h=0;h<A;h++)s=i+h,Math.abs(a-s)>3&&Math.abs(a-s)<pi.length-3&&!pi[s].bou&&(n=3*pi[s].idx,F=t.positions[n],_=t.positions[n+1],G=t.positions[n+2],ji(a),o=f(F-W,_-S,G-U),o<Ii&&o<e&&(e=o,H=a,k=s,Ai=!0))}function wi(i,s){let n;pi[i].ang=0,pi[s].ang=0,i>s&&(n=s,s=i,i=n),di=i,ui=[];let o=pi[i],e=pi[s];ui=pi.splice(i+1,s-i-1),ui.unshift(o),ui.push(e),gi.push(ui),function(){let i,s,n,o,e,a,h,l,d,c;Mi=[],e=a=h=1/0,l=d=c=-1/0;for(let r=0;r<ui.length;r++)o=3*ui[r].idx,i=t.positions[o],s=t.positions[o+1],n=t.positions[o+2],e=i<e?i:e,a=s<a?s:a,h=n<h?n:h,l=i>l?i:l,d=s>d?s:d,c=n>c?n:c;Mi.push(e,a,h,l,d,c),xi.push(Mi)}(),Pi+=1}function Hi(){m=0;let i=di,t=di+1;Fi(i),Fi(t),pi[t].ang<pi[i].ang?(Ni(t),m+=A-1,Fi(i),Ni(i)):(Ni(i),m+=A-1,Fi(t+m),Ni(t+m))}function ki(){let i,t=1/0;for(let s=0;s<pi.length;s++)pi[s].ang<t&&!pi[s].bou&&(t=pi[s].ang,i=s);return i}function Ni(i){if(fi=[],I=Math.floor(3*pi[i].ang/Math.PI)+1,P=pi[i].ang/I,Gi(i),ji(i),zi(i),ai=3*pi[i].idx,O=t.normals[ai],X=t.normals[ai+1],D=t.normals[ai+2],_i(),B=g(F-W,_-S,G-U),E=g(j-W,z-S,C-U),w=g(j-F,z-_,C-G),P<.8&&I>1&&(I--,P=pi[i].ang/I),P>.8&&1===I&&w>1.25*l&&(I=2,P=pi[i].ang/I),(B*B<.2*l*l||E*E<.2*l*l)&&(I=1),A=I-1,0===A)t.indices[ri]=pi[i].idx,t.indices[ri+1]=pi[M(i)].idx,t.indices[ri+2]=pi[x(i)].idx,ri+=3,pi[M(i)].ang=0,pi[x(i)].ang=0,pi.splice(i,1);else{si=W,ni=S,oi=U,y=P;for(let i=0;i<A;i++)ei=!1,qi(),(W>u[0]||W<u[1]||S>u[2]||S<u[3]||U>u[4]||U<u[5])&&(ei=!0,qi()),fi.push({idx:ci/3,ang:0,bou:ei}),ci+=3,y+=P;t.indices[ri]=pi[i].idx,t.indices[ri+1]=pi[M(i)].idx,t.indices[ri+2]=fi[0].idx,ri+=3,pi[M(i)].ang=0;for(let s=0;s<A-1;s++)t.indices[ri]=pi[i].idx,t.indices[ri+1]=fi[s].idx,t.indices[ri+2]=fi[s+1].idx,ri+=3;t.indices[ri]=pi[i].idx,t.indices[ri+1]=fi[A-1].idx,t.indices[ri+2]=pi[x(i)].idx,pi[x(i)].ang=0,ri+=3,function(i,t){let s=pi.splice(i,pi.length-i);for(let n=0;n<t.length;n++)pi.push(t[n]);for(let n=1;n<s.length;n++)pi.push(s[n])}(i,fi)}}function Ri(){if(Pi>0){for(let i=0;i<gi.length;i++)if(gi[i].length>0){yi=i;break}pi=gi[yi],vi=[];for(let i=0;i<pi.length;i++)Fi(i)}}function qi(){ei?(W=W>u[0]?u[0]:W,W=W<u[1]?u[1]:W,S=S>u[2]?u[2]:S,S=S<u[3]?u[3]:S,U=U>u[4]?u[4]:U,U=U<u[5]?u[5]:U):(W=si+Math.cos(y)*l*J+Math.sin(y)*l*Q,S=ni+Math.cos(y)*l*K+Math.sin(y)*l*V,U=oi+Math.cos(y)*l*L+Math.sin(y)*l*Y),Wi(),t.positions[ci]=W,t.positions[ci+1]=S,t.positions[ci+2]=U,t.normals[ci]=O,t.normals[ci+1]=X,t.normals[ci+2]=D}function Wi(){let i,t,s;for(i=W,t=S,s=U,Si();g(i-W,t-S,s-U)>d;)i=W,t=S,s=U,Si();T=g(O,X,D),O/=T,X/=T,D/=T}function Si(){let t,e;ei?(O=W===u[0]||W===u[1]?0:s(W,S,U),X=S===u[2]||S===u[3]?0:n(W,S,U),D=U===u[4]||U===u[5]?0:o(W,S,U)):(O=s(W,S,U),X=n(W,S,U),D=o(W,S,U)),t=O*O+X*X+D*D,t>d*d?e=-i(W,S,U)/t:(e=0,console.log("WARNING tri (surface_point...): newton")),W+=e*O,S+=e*X,U+=e*D}function Ui(i,t){let s=Math.atan2(t,i);return s<0&&(s+=2*Math.PI),s}function Fi(i){let t,s;Gi(i),ji(i),zi(i),function(){let i=v(J,K,L,Q,V,Y,O,X,D);Z=v(F-W,_-S,G-U,Q,V,Y,O,X,D)/i,$=v(J,K,L,F-W,_-S,G-U,O,X,D)/i,ii=v(j-W,z-S,C-U,Q,V,Y,O,X,D)/i,ti=v(J,K,L,j-W,z-S,C-U,O,X,D)/i}(),t=Ui(Z,$),s=Ui(ii,ti),s<t&&(s+=2*Math.PI),pi[i].ang=s-t,pi[i].ang<1.5&&vi.push(i)}function _i(){Q=X*(G-U)-D*(_-S),V=D*(F-W)-O*(G-U),Y=O*(_-S)-X*(F-W),T=g(Q,V,Y),Q/=T,V/=T,Y/=T,J=V*D-Y*X,K=Y*O-Q*D,L=Q*X-V*O}function Gi(i){ai=3*pi[M(i)].idx,F=t.positions[ai],_=t.positions[ai+1],G=t.positions[ai+2]}function ji(i){ai=3*pi[i].idx,W=t.positions[ai],S=t.positions[ai+1],U=t.positions[ai+2]}function zi(i){ai=3*pi[x(i)].idx,j=t.positions[ai],z=t.positions[ai+1],C=t.positions[ai+2]}}(t.isf,t.dx,t.dy,t.dz,t.xs,t.ys,t.zs,t.d,t.e,t.fc,t.pc,t.b)}i.createSphereWithHoles=function(i,o){t=this,i.d>0?(t.d=void 0!==i.d?i.d:2*Math.sin(Math.PI/24),t.div4=void 0!==i.div4?i.div4:6,t.holes=void 0!==i.holes?i.holes:[],t.detail=4*t.div4,t.radius=t.d/Math.sin(Math.PI/t.detail)/2,t.buildSphereWithHolesObj=s,t.buildSphereWithHolesObj()):(t.detail=detail,t.holes=void 0!==holes?holes:[],t.buildSphereWithHoles=n,t.buildSphereWithHoles())},i.buildSphereWithHolesObj=s,i.buildSphereWithHoles=n,i.createCylinderWithHoles=function(i){(t=this).d=void 0!==i.d?i.d:2*Math.sin(Math.PI/24),t.div4=void 0!==i.div4?i.div4:6,t.btm=void 0!==i.bottom?i.bottom:-1,t.div4Btm=void 0!==i.div4Btm?i.div4Btm:Number.MAX_SAFE_INTEGER,t.phiBtm=void 0!==i.phiBtm?i.phiBtm:0,t.top=void 0!==i.top?i.top:1,t.div4Top=void 0!==i.div4Top?i.div4Top:Number.MAX_SAFE_INTEGER,t.phiTop=void 0!==i.phiTop?i.phiTop:0,t.holes=void 0!==i.holes?i.holes:[],t.detail=4*t.div4,t.radius=t.d/Math.sin(Math.PI/t.detail)/2,t.buildCylinderWithHoles=o,t.buildCylinderWithHoles()},i.buildCylinderWithHoles=o,i.createInnerGeometry=function(i){(t=this).surface=void 0!==i.surface?i.surface:"polygon",t.holes=void 0!==i.holes?i.holes:[],"circle"!==t.surface&&"sphere"!==t.surface||(t.d=void 0!==i.d?i.d:2*Math.sin(Math.PI/24),t.div4=void 0!==i.div4?i.div4:6,t.detail=4*t.div4,t.radius=t.d/Math.sin(Math.PI/t.detail)/2),"polygon"===t.surface&&(t.d=void 0!==i.d?i.d:.1,t.polygonN=void 0!==i.polygonN?i.polygonN:6,t.divN=void 0!==i.divN?i.divN:10,t.detail=t.polygonN*t.divN,t.radius=t.d*t.divN/Math.sin(Math.PI/t.polygonN)/2),"rectangle"===t.surface&&(t.d=void 0!==i.d?i.d:.1,t.divW=void 0!==i.divW?i.divW:10,t.divH=void 0!==i.divH?i.divH:10,t.detail=2*(t.divW+t.divH)),"outline"===t.surface&&(t.d=void 0!==i.d?i.d:.1,t.points=void 0!==i.points?i.points:[1,1,-1,1,-1,-1,1,-1],t.detail=8/t.d),"planecap"===t.surface&&(t.d=void 0!==i.d?i.d:2*Math.sin(Math.PI/24),t.div4=void 0!==i.div4?i.div4:6,t.tilt=void 0!==i.tilt?i.tilt:0,t.cap=void 0!==i.cap?i.cap:"btm",t.detail=4*t.div4,t.radius=t.d/Math.sin(Math.PI/t.detail)/2,t.major=t.radius/Math.cos(t.tilt),t.sintilt=Math.sin(t.tilt),t.costilt=Math.cos(t.tilt)),"cylinder"===t.surface&&(t.d=void 0!==i.d?i.d:2*Math.sin(Math.PI/24),t.div4=void 0!==i.div4?i.div4:6,t.geoBtm=void 0!==i.geoBtm?i.geoBtm:"plane",t.btm=void 0!==i.btm?i.btm:-1,t.div4Btm=void 0!==i.div4Btm?i.div4Btm:Number.MAX_SAFE_INTEGER,t.phiBtm=void 0!==i.phiBtm?i.phiBtm:0,t.excBtm=void 0!==i.excBtm?i.excBtm:0,t.excUnitBtm=void 0!==i.excUnitBtm?i.excUnitBtm:"v",t.tiltBtm=void 0!==i.tiltBtm?i.tiltBtm:0,t.geoTop=void 0!==i.geoTop?i.geoTop:"plane",t.top=void 0!==i.top?i.top:1,t.div4Top=void 0!==i.div4Top?i.div4Top:Number.MAX_SAFE_INTEGER,t.phiTop=void 0!==i.phiTop?i.phiTop:0,t.excTop=void 0!==i.excTop?i.excTop:0,t.excUnitTop=void 0!==i.excUnitTop?i.excUnitTop:"v",t.tiltTop=void 0!==i.tiltTop?i.tiltTop:0,t.detail=4*t.div4,t.radius=t.d/Math.sin(Math.PI/t.detail)/2),t.buildInnerGeometry=e,t.buildInnerGeometry()},i.buildInnerGeometry=e,i.createImplicitSurface=function(i,s,n,o,e,h,l,d,c,r){(t=this).isf=i,t.dx=s,t.dy=n,t.dz=o,t.xs=e,t.ys=h,t.zs=l,t.d=d,t.e=c,void 0!==r?(t.fc=void 0!==r.fc?r.fc:32e4,t.pc=void 0!==r.pc?r.pc:16e4,t.b=void 0!==r.b?r.b:[]):(t.fc=32e4,t.pc=16e4,t.b=[]),t.buildImplicitSurface=a,t.buildImplicitSurface()},i.buildImplicitSurface=a,Object.defineProperty(i,"__esModule",{value:!0})});